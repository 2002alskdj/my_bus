<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title> 문막발 버스 </title>
<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #f5f6f7;
  padding: 12px;
  max-width: 420px;   /* 폭 더 줄여서 여백 감소 */
  margin: 0 auto;
  font-size: 17px;    /* 전체 글자 크기 ↑ */
}

.bus {
  background: #ffffff;
  padding: 18px;      /* 카드 안 여백 ↑ */
  border-radius: 16px;
  margin-bottom: 16px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}

.time {
  font-weight: bold;
  cursor: pointer;
  font-size: 17px;    /* 버스 제목 더 크게 */
}

.soon {
  color: #1e88e5;
  margin-top: 6px;
  font-size: 15px;
}

.detail {
  display: none;
  margin-top: 10px;
  font-size: 15px;
  color: #555;
  line-height: 1.5;
}

/* 요일 토글 버튼 */
.day-toggle {
  margin-bottom: 14px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.day-toggle button {
  border: none;
  padding: 9px 15px;  /* 버튼 키우기 */
  border-radius: 999px;
  background: #e0e3e7;
  cursor: pointer;
  font-size: 14px;
}
.day-toggle button.active {
  background: #1e88e5;
  color: #fff;
}

/* 아주 작은 화면(<=480px)에서 추가 조정 */
@media (max-width: 480px) {
  body {
    padding: 10px;
    font-size: 17px;
  }
  h2#today {
    font-size: 19px;
  }
}
  
</style>
</head>

<body>
<h2 id="today"></h2>

<p style="font-size:13px;color:#777;margin:4px 0 12px;">
  도착시간: 문막주공아파트 정류장 기준 <br>
  ※ 정확한 도착 예정 시각은 공식 버스 앱을 참고하세요.
</p>

<div class="day-toggle">
  <button id="btn-auto"      onclick="setDayOverride('auto')">오늘 기준</button>
  <button id="btn-weekday"   onclick="setDayOverride('평일')">평일 시간표</button>
  <button id="btn-saturday"  onclick="setDayOverride('토요일')">토요일 시간표</button>
  <button id="btn-holiday"   onclick="setDayOverride('일, 공휴일')">일·공휴일 시간표</button>
</div>

<div id="busList"></div>

<script>
// 상세 시간표 토글 함수
function toggleDetail(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display =
    (el.style.display === "none" || el.style.display === "") ? "block" : "none";
}

// 실제 오늘 요일
function getDayTypeFromDate() {
  const d = new Date().getDay();
  if (d === 0) return "일, 공휴일";
  if (d === 6) return "토요일";
  return "평일";
}

// "평일, 토요일" 같은 문자열에 오늘 요일이 포함되는지 확인
function isTodayIncluded(type, dayType) {
  const t = String(type || "").trim();
  if (t === "전체") return true;

  const tokens = t.split(",").map(s => s.trim()); // 예: ["일", "공휴일"]

  // "일·공휴일 보기"일 때는 둘 중 하나라도 포함되면 true
  if (dayType === "일, 공휴일") {
    return tokens.includes("일") || tokens.includes("공휴일");
  }

  // 그 외(평일, 토요일)는 기존처럼
  return tokens.includes(dayType);
}

// 시간 문자열 → 분
function toMin(t) {
  const [h, m] = t.split(":").map(Number);
  return h * 60 + m;
}

// 분 → HH:MM
function toTime(m) {
  return `${String(Math.floor(m / 60)).padStart(2, "0")}:${String(m % 60).padStart(2, "0")}`;
}

// 요일 오버라이드 상태: "auto" | "평일" | "토요일" | "일, 공휴일"
let dayOverride = "auto";

function getCurrentDayType() {
  if (dayOverride === "auto") return getDayTypeFromDate();
  return dayOverride;
}

// 버튼 active 상태 갱신
function updateDayButtons() {
  const map = {
    auto: 'btn-auto',
    '평일': 'btn-weekday',
    '토요일': 'btn-saturday',
    '일, 공휴일': 'btn-holiday'
  };
  Object.values(map).forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.classList.remove('active');
  });
  const activeId = map[dayOverride];
  const activeBtn = document.getElementById(activeId);
  if (activeBtn) activeBtn.classList.add('active');
}

function setDayOverride(v) {
  dayOverride = v;
  updateDayButtons();
  load(); // 다시 계산해서 화면 갱신
}

// 버스번호 기준으로 전체 출발/도착 시간표 HTML 생성
function buildFullScheduleHtml(busNo, dayType, rawSchedule, offsetData) {
  const rows = rawSchedule.filter(row =>
    row.bus === busNo && isTodayIncluded(row.type, dayType)
  );

  const lines = [];

  rows.forEach(row => {
    row.times.forEach(t => {
      const base = toMin(t);
      const off = offsetData.find(o =>
        o.bus === row.bus &&
        o.origin === row.origin &&
        isTodayIncluded(o.type, dayType)
      );
      const offset = off ? off.offset_min : 0;
      const arrive = base + offset;
      const departStr = t.length === 4 ? `0${t}` : t; // 7:05 → 07:05
      lines.push(`${departStr} 출발 → ${toTime(arrive)} 정류장 도착`);
    });
  });

  lines.sort(); // 시간순 정렬
  return lines.join("<br>");
}

async function load() {
  const rawSchedule = await fetch("./raw_schedule.json").then(r => r.json());
  const offsetData = await fetch("./offset.json").then(r => r.json());

  const now = new Date();
  const nowMin = now.getHours() * 60 + now.getMinutes();
  const dayType = getCurrentDayType();
  const realDay = getDayTypeFromDate();

  const title = (dayOverride === 'auto')
    ? `오늘 (${realDay}) · 현재 ${toTime(nowMin)}`
    : `선택 요일: ${dayType} (오늘은 ${realDay}) · 기준시각 ${toTime(nowMin)}`;
  document.getElementById("today").innerText = title;

  const box = document.getElementById("busList");
  box.innerHTML = "";

  if (dayOverride === 'auto') {
    // ===== 오늘 기준: 다음 버스 + 남은 시간 =====
    const GRACE_MIN = 3; // 도착 후 3분까지는 0분으로 남겨두기
    let result = [];

    rawSchedule.forEach(row => {
      if (!isTodayIncluded(row.type, dayType)) return;

      row.times.forEach(t => {
        const base = toMin(t); // 종점 출발 시각

        const off = offsetData.find(o =>
          o.bus === row.bus &&
          o.origin === row.origin &&
          isTodayIncluded(o.type, dayType)
        );

        const offset = off ? off.offset_min : 0;
        const arrive = base + offset; // 정류장 도착 시각

        if (arrive >= nowMin - GRACE_MIN) {
          const remainRaw = arrive - nowMin;
          const remain = Math.max(remainRaw, 0);

          result.push({
            bus: row.bus,
            origin: row.origin,
            departTime: toTime(base),
            arriveTime: toTime(arrive),
            remain: remain
          });
        }
      });
    });

    result.sort((a, b) => a.remain - b.remain);

    const byBus = {};
    result.forEach(r => {
      if (!byBus[r.bus]) byBus[r.bus] = [];
      byBus[r.bus].push(r);
    });

    const mainList = Object.keys(byBus).map(busNo => {
      const times = byBus[busNo];
      return {
        bus: busNo,
        origin: times[0].origin,
        next: times[0],
        all: times
      };
    });

    mainList.forEach(item => {
      const id = `bus-${item.bus}`;
      const detailHtml = buildFullScheduleHtml(
        item.bus,
        dayType,
        rawSchedule,
        offsetData
      );

      box.innerHTML += `
        <div class="bus">
          <div class="time" onclick="toggleDetail('${id}')">
            ${item.bus}번 · ${item.next.departTime} 출발 (${item.origin})
          </div>
          <div class="soon">${item.next.remain}분 후 정류장 도착</div>
          <div id="${id}" class="detail">
            ${detailHtml}
          </div>
        </div>
      `;
    });
  } else {
    // ===== 평일/토요일/일·공휴일 보기: 버스번호 목록 + 전체 시간표 =====
    const todayRows = rawSchedule.filter(row =>
      isTodayIncluded(row.type, dayType)
    );

    const busSet = new Set(todayRows.map(row => row.bus));
    const busList = Array.from(busSet).sort();

    busList.forEach(busNo => {
      const id = `bus-${busNo}`;
      const sampleRow = todayRows.find(r => r.bus === busNo);
      const origin = sampleRow ? sampleRow.origin : "";

      const detailHtml = buildFullScheduleHtml(
        busNo,
        dayType,
        rawSchedule,
        offsetData
      );

      box.innerHTML += `
        <div class="bus">
          <div class="time" onclick="toggleDetail('${id}')">
            ${busNo}번 (${origin})
          </div>
          <div id="${id}" class="detail">
            ${detailHtml}
          </div>
        </div>
      `;
    });
  }
}

// 처음 로딩 시 버튼 상태 세팅 후 데이터 로드
updateDayButtons();
load();
</script>
</body>
</html>






