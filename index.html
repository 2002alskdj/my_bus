<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>집 정류장 버스</title>
<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #f5f6f7;
  padding: 20px;
}
.bus {
  background: #ffffff;
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.time {
  font-weight: bold;
  cursor: pointer;
}
.soon {
  color: #1e88e5;
  margin-top: 4px;
}
.detail {
  display: none;
  margin-top: 8px;
  font-size: 14px;
  color: #555;
  line-height: 1.4;
}

/* 요일 토글 버튼 */
.day-toggle {
  margin-bottom: 12px;
}
.day-toggle button {
  border: none;
  padding: 6px 10px;
  margin-right: 6px;
  border-radius: 999px;
  background: #e0e3e7;
  cursor: pointer;
  font-size: 13px;
}
.day-toggle button.active {
  background: #1e88e5;
  color: #fff;
}
</style>
</head>

<body>
<h2 id="today"></h2>

<div class="day-toggle">
  <button id="btn-auto"      onclick="setDayOverride('auto')">오늘 기준</button>
  <button id="btn-weekday"   onclick="setDayOverride('평일')">평일 보기</button>
  <button id="btn-saturday"  onclick="setDayOverride('토요일')">토요일 보기</button>
  <button id="btn-holiday"   onclick="setDayOverride('일, 공휴일')">일·공휴일 보기</button>
</div>

<div id="busList"></div>

<script>
// 상세 시간표 토글 함수
function toggleDetail(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display =
    (el.style.display === "none" || el.style.display === "") ? "block" : "none";
}

// 실제 오늘 요일
function getDayTypeFromDate() {
  const d = new Date().getDay();
  if (d === 0) return "일, 공휴일";
  if (d === 6) return "토요일";
  return "평일";
}

// "평일, 토요일" 같은 문자열에 오늘 요일이 포함되는지 확인
function isTodayIncluded(type, dayType) {
  const t = String(type || "").trim();
  if (t === "전체") return true;
  return t.split(",").map(s => s.trim()).includes(dayType);
}

// 시간 문자열 → 분
function toMin(t) {
  const [h, m] = t.split(":").map(Number);
  return h * 60 + m;
}

// 분 → HH:MM
function toTime(m) {
  return `${String(Math.floor(m / 60)).padStart(2, "0")}:${String(m % 60).padStart(2, "0")}`;
}

// 요일 오버라이드 상태: "auto" | "평일" | "토요일" | "일, 공휴일"
let dayOverride = "auto";

function getCurrentDayType() {
  if (dayOverride === "auto") return getDayTypeFromDate();
  return dayOverride;
}

// 버튼 active 상태 갱신
function updateDayButtons() {
  const map = {
    auto: 'btn-auto',
    '평일': 'btn-weekday',
    '토요일': 'btn-saturday',
    '일, 공휴일': 'btn-holiday'
  };
  Object.values(map).forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.classList.remove('active');
  });
  const activeId = map[dayOverride];
  const activeBtn = document.getElementById(activeId);
  if (activeBtn) activeBtn.classList.add('active');
}

function setDayOverride(v) {
  dayOverride = v;
  updateDayButtons();
  load(); // 다시 계산해서 화면 갱신
}

// 버스번호 기준으로 오늘 전체 도착 시각표 HTML 생성 (남은 시간 표시 없음)
function buildFullScheduleHtml(busNo, dayType, rawSchedule, offsetData) {
  const rows = rawSchedule.filter(row =>
    row.bus === busNo && isTodayIncluded(row.type, dayType)
  );

  const lines = [];

  rows.forEach(row => {
    row.times.forEach(t => {
      const base = toMin(t);
      const off = offsetData.find(o =>
        o.bus === row.bus &&
        o.origin === row.origin &&
        isTodayIncluded(o.type, dayType)
      );
      const offset = off ? off.offset_min : 0;
      const arrive = base + offset;
      lines.push(toTime(arrive));
    });
  });

  lines.sort(); // 시간순 정렬
  return lines.join("<br>");
}

async function load() {
  const rawSchedule = await fetch("./raw_schedule.json").then(r => r.json());
  const offsetData = await fetch("./offset.json").then(r => r.json());

  const now = new Date();
  const nowMin = now.getHours() * 60 + now.getMinutes();
  const dayType = getCurrentDayType();

  const realDay = getDayTypeFromDate();
  const title = (dayOverride === 'auto')
    ? `오늘 (${realDay}) · 현재 ${toTime(nowMin)}`
    : `선택 요일: ${dayType} (오늘은 ${realDay}) · 기준시각 ${toTime(nowMin)}`;
  document.getElementById("today").innerText = title;

  let result = [];

  rawSchedule.forEach(row => {
    if (!isTodayIncluded(row.type, dayType)) return;

    row.times.forEach(t => {
      const base = toMin(t);

      const off = offsetData.find(o =>
        o.bus === row.bus &&
        o.origin === row.origin &&
        isTodayIncluded(o.type, dayType)
      );

      const offset = off ? off.offset_min : 0;
      const arrive = base + offset;

      if (arrive >= nowMin) {
        result.push({
          bus: row.bus,
          origin: row.origin,
          time: toTime(arrive),
          remain: arrive - nowMin
        });
      }
    });
  });

  // 남은 시간 기준 정렬
  result.sort((a, b) => a.remain - b.remain);

  // 버스 번호별로 그룹화
  const byBus = {};
  result.forEach(r => {
    if (!byBus[r.bus]) byBus[r.bus] = [];
    byBus[r.bus].push(r);
  });

  const mainList = Object.keys(byBus).map(busNo => {
    const times = byBus[busNo];
    return {
      bus: busNo,
      origin: times[0].origin,
      next: times[0],
      all: times
    };
  });

  const box = document.getElementById("busList");
  box.innerHTML = "";

  mainList.forEach(item => {
    const id = `bus-${item.bus}`;
    const detailHtml = buildFullScheduleHtml(
      item.bus,
      dayType,
      rawSchedule,
      offsetData
    );

    box.innerHTML += `
      <div class="bus">
        <div class="time" onclick="toggleDetail('${id}')">
          ${item.bus}번 · ${item.next.time} (${item.origin})
        </div>
        <div class="soon">${item.next.remain}분 후 도착</div>
        <div id="${id}" class="detail">
          ${detailHtml}
        </div>
      </div>
    `;
  });
}

// 처음 로딩 시 버튼 상태 세팅 후 데이터 로드
updateDayButtons();
load();
</script>
</body>
</html>


